# Cilium {{ cilium_version }} Helm values - Minimal setup for K3s with LB-IPAM
# Based on latest Cilium best practices and blog.stonegarden.dev
image:
  repository: quay.io/cilium/cilium
  tag: v{{ cilium_version }}
  pullPolicy: IfNotPresent

# K3s API server endpoint - point to first server to avoid chicken-and-egg
k8sServiceHost: {{ hostvars[groups['servers'][0]]['ansible_host'] }}
k8sServicePort: 6443

# Disable DNS proxy to avoid conflicts with CoreDNS
dnsProxy:
  enabled: false

# CNI configuration
cni:
  chainingMode: none
  install: true
  exclusive: true

# L2 Announcements - Essential for LB-IPAM to work
# Lease timing optimized for small 2-node cluster with faster failover (~4-8s)
l2announcements:
  enabled: true
  leaseDuration: 8s
  leaseRenewDeadline: 4s
  leaseRetryPeriod: 1s

# BGP Control Plane - Disabled (not needed for L2-only networking)
bgpControlPlane:
  enabled: false

# LoadBalancer IPAM - Replaces kube-vip/MetalLB
loadBalancer:
  mode: dsr

# IPAM mode
ipam:
  mode: kubernetes

# Kube-proxy replacement - Cilium handles all service load balancing
kubeProxyReplacement: true

# NodePort support
nodePort:
  enabled: true

# External IPs support
externalIPs:
  enabled: true

# Client rate limiting
k8sClientRateLimit:
  qps: 50
  burst: 200

# IPv4/IPv6 settings
ipv4:
  enabled: true
ipv6:
  enabled: false

# Native routing
routingMode: native
ipv4NativeRoutingCIDR: 10.42.0.0/16

# Masquerading
masquerade: true

# Ingress Controller - Disabled (using ingress-nginx instead)
# Cilium ingress advanced features require Envoy which is disabled for ARM64 memory constraints
ingressController:
  enabled: false

# Operator configuration
operator:
  enabled: true
  rollOutPods: true
  replicas: 1

# Auto-rollout on config changes
rollOutCiliumPods: true

# Disable unused features for minimal setup
hubble:
  enabled: false
envoy:
  enabled: false
hostFirewall:
  enabled: false
bandwidthManager:
  enabled: false
bbr: false
egressGateway:
  enabled: false
gatewayAPI:
  enabled: false
clustermesh:
  apiserver:
    enabled: false
preflight:
    enabled: false

# Basic policy mode
policyEnforcementMode: default

# Prometheus metrics with ServiceMonitor for automatic scraping
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true