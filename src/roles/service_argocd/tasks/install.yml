- name: Deploy namespace
  import_tasks: namespace.yml

- name: Add Argo repo
  kubernetes.core.helm_repository:
    state: present
    name: argocd
    repo_url: https://argoproj.github.io/argo-helm
  tags:
    - argo

- name: Deploy ArgoCD to cluster
  kubernetes.core.helm:
    update_repo_cache: true
    state: present
    name: argo-cd
    chart_ref: argocd/argo-cd
    release_namespace: '{{ argocd_k8s_namespace }}'
    create_namespace: true
    release_values: "{{ lookup('file', '{{ role_path }}/files/values.yml') | from_yaml }}"
    wait: true
  tags:
    - argo
    - gitops
