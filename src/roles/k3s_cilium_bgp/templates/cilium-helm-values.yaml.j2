# Cilium {{ cilium_version }} Helm values for K3s with BGP control plane
image:
  repository: quay.io/cilium/cilium
  tag: v{{ cilium_version }}
  pullPolicy: IfNotPresent

# Disable Hubble for now to keep it simple
hubble:
  enabled: false

# Disable Envoy (not needed for BGP, saves memory on Pi)
envoy:
  enabled: false

# K3s API server endpoint
# Point to first server node directly (not ClusterIP) to avoid chicken-and-egg problem
# In kube-proxy-free mode, Cilium must reach API before ClusterIP services work
k8sServiceHost: {{ hostvars[groups['servers'][0]]['ansible_host'] }}
k8sServicePort: 6443

# CNI configuration
cni:
  chainingMode: none
  install: true
  exclusive: true

# L2 Announcements - Respond to ARP requests for LoadBalancer IPs
l2announcements:
  enabled: true
  # Lease configuration for HA
  leaseDuration: 15s
  leaseRenewDeadline: 5s
  leaseRetryPeriod: 2s

# LoadBalancer IPAM
loadBalancer:
  mode: dsr

# IPAM configuration
ipam:
  mode: kubernetes

# Enable kube-proxy replacement - Cilium handles all service load balancing
kubeProxyReplacement: true

# NodePort configuration
nodePort:
  enabled: true

# External IPs (required for LoadBalancer traffic)
externalIPs:
  enabled: true

# Host firewall
hostFirewall:
  enabled: false

# Bandwidth manager
bandwidthManager:
  enabled: false

# BBR congestion control
bbr: false

# IPv4/IPv6 settings
ipv4:
  enabled: true
ipv6:
  enabled: false

# Routing mode
routingMode: native

# Native routing CIDR (K3s default pod network)
ipv4NativeRoutingCIDR: 10.42.0.0/16

# Masquerading
masquerade: true

# Egress gateway
egressGateway:
  enabled: false

# Ingress controller
ingressController:
  enabled: false

# Gateway API
gatewayAPI:
  enabled: false

# Cluster mesh
clustermesh:
  apiserver:
    enabled: false

# Policy enforcement
policyEnforcementMode: default

# Prometheus metrics
prometheus:
  enabled: true
  serviceMonitor:
    enabled: false

# Operator configuration
operator:
  enabled: true
  replicas: 1
  image:
    repository: quay.io/cilium/operator
    tag: v{{ cilium_version }}
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: false

# Preflight configuration
preflight:
  enabled: false

# Roll out cilium agent pods automatically when ConfigMap is updated
rollOutCiliumPods: true

# Security context - add NET_BIND_SERVICE for BGP port 179
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_MODULE
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
      - NET_BIND_SERVICE

